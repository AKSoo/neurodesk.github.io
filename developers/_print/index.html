<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1"><link rel=canonical type=text/html href=https://neurodesk.github.io/developers/>
<link rel=alternate type=application/rss+xml href=https://neurodesk.github.io/developers/index.xml>
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Developers | NeuroDesk</title>
<meta name=description content="Documentation for Developers
">
<meta property="og:title" content="Developers">
<meta property="og:description" content="Documentation for Developers
">
<meta property="og:type" content="website">
<meta property="og:url" content="https://neurodesk.github.io/developers/"><meta property="og:site_name" content="NeuroDesk">
<meta itemprop=name content="Developers">
<meta itemprop=description content="Documentation for Developers
"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Developers">
<meta name=twitter:description content="Documentation for Developers
">
<link rel=preload href=/scss/main.min.54a6b13de98a6b564f59b9d4cda427d6ae62ab54c015b5b9f5ed167c2da7fdd5.css as=style>
<link href=/scss/main.min.54a6b13de98a6b564f59b9d4cda427d6ae62ab54c015b5b9f5ed167c2da7fdd5.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<link rel=stylesheet href=/css/prism.css>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-00000000-0','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo></span><span class="text-uppercase font-weight-bold">NeuroDesk</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/docs/><span>Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/developers/><span class=active>Developers</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/blog/><span>News</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=https://github.com/NeuroDesk target=_blank><i class="fab fa-github"></i><span>GitHub</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href=/developers/>Return to the regular view of this page</a>.
</p>
</div>
<h1 class=title>Developers</h1>
<div class=lead>Documentation for Developers</div>
<ul>
<li>1: <a href=#pg-9dfb256e35d7dd91e05a33ec675f72e4>Neurodesk CVMFS</a></li>
<ul>
<li>1.1: <a href=#pg-7d2cf5c0520f7ea412450bf2c795e035>Setup CVMFS Proxy</a></li>
<li>1.2: <a href=#pg-c25efc2b343b28af52b4173ce3a803a3>Setup Stratum 1 server</a></li>
</ul>
<li>2: <a href=#pg-95ed7c5681d2faa66b764be030124e59>Architecture</a></li>
<ul>
<li>2.1: <a href=#pg-7fb26fe1d8d5b2d4ce62381ae2bcf701>CVMFS architecture</a></li>
<li>2.2: <a href=#pg-563591a7e975c9f90c317bf391d61e75>Neurodesk Architecture</a></li>
</ul>
<li>3: <a href=#pg-fd28a1b5010f2ff02bb480802674fb39>How to add new tools</a></li>
<ul>
<li>3.1: <a href=#pg-e24a02244ddbf4a83fcf0095e3003590>Add tools</a></li>
<li>3.2: <a href=#pg-f706aedba5bc93ee895c966642b91365>Menu entries</a></li>
</ul>
<li>4: <a href=#pg-f89498a0fd2d201e1dc7e27d7be9f337>Transparent Singularity</a></li>
<ul>
</ul>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-9dfb256e35d7dd91e05a33ec675f72e4>1 - Neurodesk CVMFS</h1>
<div class=lead>How to interact with our CVMFS service.</div>
</div>
<div class=td-content>
<h1 id=pg-7d2cf5c0520f7ea412450bf2c795e035>1.1 - Setup CVMFS Proxy</h1>
<div class=lead>Setup CVMFS Proxy server</div>
<p>If you want more speed in a region one way could be to setup another Stratum 1 server or a proxy. We currently don&rsquo;t run any proxy servers but it would be important for using it on a cluster.</p>
<h1 id=setup-a-cvmfs-proxy-server>Setup a CVMFS proxy server</h1>
<div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo yum install -y squid

sudo vi /etc/squid/squid.conf

<span style=color:#8f5902;font-style:italic># List of local IP addresses (separate IPs and/or CIDR notation) allowed to access your local proxy</span>
<span style=color:#8f5902;font-style:italic>#acl local_nodes src YOUR_CLIENT_IPS</span>

<span style=color:#8f5902;font-style:italic># Destination domains that are allowed</span>
<span style=color:#8f5902;font-style:italic>#acl stratum_ones dstdomain .YOURDOMAIN.ORG</span>
<span style=color:#8f5902;font-style:italic>#acl stratum_ones dstdom_regex YOUR_REGEX</span>
acl stratum_ones dst 140.238.211.92

<span style=color:#8f5902;font-style:italic># Squid port</span>
http_port <span style=color:#0000cf;font-weight:700>3128</span>

<span style=color:#8f5902;font-style:italic># Deny access to anything which is not part of our stratum_ones ACL.</span>
http_access deny !stratum_ones

<span style=color:#8f5902;font-style:italic># Only allow access from our local machines</span>
<span style=color:#8f5902;font-style:italic>#http_access allow local_nodes</span>
http_access allow localhost

<span style=color:#8f5902;font-style:italic># Finally, deny all other access to this proxy</span>
http_access deny all

minimum_expiry_time <span style=color:#0000cf;font-weight:700>0</span>
maximum_object_size <span style=color:#0000cf;font-weight:700>1024</span> MB

cache_mem <span style=color:#0000cf;font-weight:700>128</span> MB
maximum_object_size_in_memory <span style=color:#0000cf;font-weight:700>128</span> KB
<span style=color:#8f5902;font-style:italic># 5 GB disk cache</span>
cache_dir ufs /var/spool/squid <span style=color:#0000cf;font-weight:700>5000</span> <span style=color:#0000cf;font-weight:700>16</span> <span style=color:#0000cf;font-weight:700>256</span>



sudo squid -k parse

sudo systemctl start squid
sudo systemctl <span style=color:#204a87>enable</span> squid
sudo systemctl status squid
sudo systemctl restart squid
</code></pre></td></tr></table>
</div>
</div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c25efc2b343b28af52b4173ce3a803a3>1.2 - Setup Stratum 1 server</h1>
<div class=lead>Host a Stratum 1 server</div>
<p>The stratum 1 servers for the desktop are configured here: <a href=https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile>https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile</a></p>
<p>If you want more speed in a region one way could be to setup another Stratum 1 server or a proxy.</p>
<h1 id=setup-a-stratum-1-server>Setup a Stratum 1 server:</h1>
<div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo yum install -y https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm
sudo yum install -y cvmfs-server squid
sudo yum install -y python3-mod_wsgi 

sudo sed -i <span style=color:#4e9a06>&#39;s/Listen 80/Listen 127.0.0.1:8080/&#39;</span> /etc/httpd/conf/httpd.conf

<span style=color:#204a87>set</span> +H
<span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;http_port 80 accel&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee /etc/squid/squid.conf
<span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;http_port 8000 accel&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee -a /etc/squid/squid.conf
<span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;http_access allow all&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee -a /etc/squid/squid.conf
<span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;cache_peer 127.0.0.1 parent 8080 0 no-query originserver&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee -a /etc/squid/squid.conf
<span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;acl CVMFSAPI urlpath_regex ^/cvmfs/[^/]*/api/&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee -a /etc/squid/squid.conf
<span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;cache deny !CVMFSAPI&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee -a /etc/squid/squid.conf
<span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;cache_mem 128 MB&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee -a /etc/squid/squid.conf

sudo systemctl start httpd
sudo systemctl start squid
sudo systemctl <span style=color:#204a87>enable</span> httpd
sudo systemctl <span style=color:#204a87>enable</span> squid

<span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#39;CVMFS_GEO_LICENSE_KEY=kGepdzqbAP4fjf5X&#39;</span> <span style=color:#000;font-weight:700>|</span> sudo tee -a /etc/cvmfs/server.local
sudo chmod <span style=color:#0000cf;font-weight:700>600</span> /etc/cvmfs/server.local

sudo mkdir -p /etc/cvmfs/keys/ardc.edu.au/

<span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;-----BEGIN PUBLIC KEY-----
</span><span style=color:#4e9a06>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwUPEmxDp217SAtZxaBep
</span><span style=color:#4e9a06>Bi2TQcLoh5AJ//HSIz68ypjOGFjwExGlHb95Frhu1SpcH5OASbV+jJ60oEBLi3sD
</span><span style=color:#4e9a06>qA6rGYt9kVi90lWvEjQnhBkPb0uWcp1gNqQAUocybCzHvoiG3fUzAe259CrK09qR
</span><span style=color:#4e9a06>pX8sZhgK3eHlfx4ycyMiIQeg66AHlgVCJ2fKa6fl1vnh6adJEPULmn6vZnevvUke
</span><span style=color:#4e9a06>I6U1VcYTKm5dPMrOlY/fGimKlyWvivzVv1laa5TAR2Dt4CfdQncOz+rkXmWjLjkD
</span><span style=color:#4e9a06>87WMiTgtKybsmMLb2yCGSgLSArlSWhbMA0MaZSzAwE9PJKCCMvTANo5644zc8jBe
</span><span style=color:#4e9a06>NQIDAQAB
</span><span style=color:#4e9a06>-----END PUBLIC KEY-----&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee /etc/cvmfs/keys/ardc.edu.au/neurodesk.ardc.edu.au.pub


sudo cvmfs_server add-replica -o <span style=color:#000>$USER</span> http://203.101.226.164/cvmfs/neurodesk.ardc.edu.au /etc/cvmfs/keys/ardc.edu.au

<span style=color:#8f5902;font-style:italic># CVMFS will store everything in /srv/cvmfs so make sure there is enough space or create a symlink to a bigger storage volume</span>
<span style=color:#8f5902;font-style:italic># e.g.:</span>
&lt;!-- <span style=color:#204a87>cd</span> /storage
sudo mkdir -p cvmfs-storage/srv/
<span style=color:#204a87>cd</span> /srv/
sudo mv cvmfs/ /storage/cvmfs-storage/srv/
sudo ln -s /storage/cvmfs-storage/srv/cvmfs/ --&gt;


sudo cvmfs_server snapshot neurodesk.ardc.edu.au


<span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;/var/log/cvmfs/*.log {
</span><span style=color:#4e9a06>    weekly
</span><span style=color:#4e9a06>    missingok
</span><span style=color:#4e9a06>    notifempty
</span><span style=color:#4e9a06>}&#34;</span> <span style=color:#000;font-weight:700>|</span> sudo tee /etc/logrotate.d/cvmfs


<span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#39;*/5 * * * * root output=$(/usr/bin/cvmfs_server snapshot -a -i 2&gt;&amp;1) || echo &#34;$output&#34; &#39;</span> <span style=color:#000;font-weight:700>|</span> sudo tee /etc/cron.d/cvmfs_stratum1_snapshot

sudo yum install iptables
sudo iptables -t nat -A PREROUTING -p tcp -m tcp --dport <span style=color:#0000cf;font-weight:700>80</span> -j REDIRECT --to-ports <span style=color:#0000cf;font-weight:700>8000</span>

sudo systemctl disable firewalld 
sudo systemctl stop firewalld 
<span style=color:#8f5902;font-style:italic># make sure that port 80 is open in the real firewall</span>

sudo cvmfs_server update-geodb
</code></pre></td></tr></table>
</div>
</div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-95ed7c5681d2faa66b764be030124e59>2 - Architecture</h1>
<div class=lead>The architecture of the Neurodesk ecosystem</div>
</div>
<div class=td-content>
<h1 id=pg-7fb26fe1d8d5b2d4ce62381ae2bcf701>2.1 - CVMFS architecture</h1>
<div class=lead>CVMFS architecture</div>
<p>We store our singuarlity containers unpacked on CVMFS. We tried the DUCC tool in the beginning, but it was causing too many issues with dockerhub and we were rate limited. The script to unpack our singularity containers is here: <a href=https://github.com/NeuroDesk/neurocommand/blob/main/cvmfs/sync_containers_to_cvmfs.sh>https://github.com/NeuroDesk/neurocommand/blob/main/cvmfs/sync_containers_to_cvmfs.sh</a></p>
<p>It gets called by a cronjob on the CVMFS Stratum 0 server and relies on the log.txt file being updated via an action in the neurocommand repository (<a href=https://github.com/NeuroDesk/neurocommand/blob/main/.github/workflows/upload_containers_simg.sh>https://github.com/NeuroDesk/neurocommand/blob/main/.github/workflows/upload_containers_simg.sh</a>)</p>
<p>The Stratum 1 servers then pull this repo from Stratum 0 and our desktops mount these repos (configured here: <a href=https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile>https://github.com/NeuroDesk/neurodesktop/blob/main/Dockerfile</a>)</p>
<p>The startup script (<a href=https://github.com/NeuroDesk/neurodesktop/blob/main/config/startup.sh>https://github.com/NeuroDesk/neurodesktop/blob/main/config/startup.sh</a>) sets up CVMFS and tests which server is fastest during the container startup.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-563591a7e975c9f90c317bf391d61e75>2.2 - Neurodesk Architecture</h1>
<div class=lead>The architecture of the Neurodesk ecosystem</div>
<h1 id=layers>Layers</h1>
<p>Neurodesktop: <a href=https://github.com/NeuroDesk/neurodesktop>https://github.com/NeuroDesk/neurodesktop</a></p>
<ul>
<li>docker container with interface modifications</li>
<li>contains tools necessary to manage containers: vscode, git, niype</li>
<li>CI: builds docker image and tests if it runs</li>
</ul>
<p>Neurocommand: <a href=https://github.com/NeuroDesk/neurocommand>https://github.com/NeuroDesk/neurocommand</a></p>
<ul>
<li>script to install and manage multiple containers using transparent singularity on any linux system</li>
<li>this repo would also handle the creation of menu entries in a general form applicable to different desktop environments</li>
<li>this repo can be re-used in other projects like CVL and the imaging workstations</li>
<li>CI: tests if containers can be installed</li>
</ul>
<p>transparent-singularity: <a href=https://github.com/NeuroDesk/transparent-singularity>https://github.com/NeuroDesk/transparent-singularity</a></p>
<ul>
<li>script to install neuro-sub-containers, installers are called by neurodesk script</li>
<li>this repo could provide a simple way of using our containers on HPCs for large scale processing of the pipelines build in VNM</li>
<li>CI: test if exposing of binaries work</li>
</ul>
<p>Neurocontainers: <a href=https://github.com/NeuroDesk/neurocontainers>https://github.com/NeuroDesk/neurocontainers</a></p>
<ul>
<li>build scripts for neuro-sub-containers</li>
<li>CI: building, pushing and testing of containers</li>
</ul>
<p>Neurodocker: <a href=https://github.com/NeuroDesk/neurodocker>https://github.com/NeuroDesk/neurodocker</a></p>
<ul>
<li>fork of neurodocker project</li>
<li>provides recipes for our containers built</li>
<li>we are providing pull requests back of recipes</li>
<li>CI: handled by <a href=https://github.com/ReproNim/neurodocker>neurodocker</a> - testing of generating container recipes</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-fd28a1b5010f2ff02bb480802674fb39>3 - How to add new tools</h1>
<div class=lead>How to add new tools to neurodesk</div>
</div>
<div class=td-content>
<h1 id=pg-e24a02244ddbf4a83fcf0095e3003590>3.1 - Add tools</h1>
<div class=lead>Add a tool to neurodesktop</div>
<p>The goal of <em>neurodesk</em> is to provide users with a large choice of tools to use in their pipelines.
Use the guide below to add a tool to <em>neurodesktop</em> or <em>neurocontainers</em>.</p>
<h2 id=guiding-principles>Guiding principles</h2>
<p>To decide if a tool should be packaged in a singularity container in <em>neurocontainers</em> or be installed in the <em>neurodesktop</em> container we are currently following these guiding principles:</p>
<ol>
<li><em>neurodesk</em> is not a package manager. This means we are not distributing tools in containers that can easily be installed via a standard package manager</li>
<li><em>neurodesk</em> allows users to have multiple versions of tools in parallel via <a href=https://lmod.readthedocs.io/en/latest/>lmod</a>, this means that if different versions of a tool can&rsquo;t be installed in parallel we package the tool inside a container.</li>
<li><em>neurodesk</em> aims to provide tooling to link tools from different containers (such as workflow managers like nipype or nextflow). This means that if a tool is required to coordinate various container-tools, it should be in the <em>neurodesktop</em> container.</li>
</ol>
<p>Examples:</p>
<table>
<thead>
<tr>
<th></th>
<th>easy install</th>
<th>coordinates containers</th>
<th>small in size</th>
<th>latest version is ok</th>
<th>useful more most users</th>
<th>Conclusion</th>
</tr>
</thead>
<tbody>
<tr>
<td>git</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>neurodesktop</td>
</tr>
<tr>
<td>lmod</td>
<td>no</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>neurodesktop</td>
</tr>
<tr>
<td>nipype</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>neurodesktop</td>
</tr>
<tr>
<td>vscode</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>neurodesktop</td>
</tr>
<tr>
<td>itksnap</td>
<td>yes</td>
<td>no</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>container?</td>
</tr>
<tr>
<td>convert3D</td>
<td>yes</td>
<td>no</td>
<td>yes</td>
<td>no</td>
<td>no</td>
<td>container</td>
</tr>
<tr>
<td>fsl</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>container</td>
</tr>
<tr>
<td>mrtrix</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>container</td>
</tr>
<tr>
<td>freesurfer</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>no</td>
<td>container</td>
</tr>
</tbody>
</table>
<h2 id=adding-new-recipes>Adding new recipes</h2>
<p>Refer to <a href=https://github.com/NeuroDesk/neurodocker>neurodocker</a> for more information on neurodocker recipes</p>
<h2 id=build-container>Build container</h2>
<p>To build a container:</p>
<ol>
<li>Pull-in latest changes from Neurodocker upstream into our fork: <a href=https://github.com/NeuroDesk/neurodocker>https://github.com/NeuroDesk/neurodocker</a> - add recipe to neurodocker if relevant for their project (<a href=https://github.com/NeuroDesk/neurodocker>https://github.com/NeuroDesk/neurodocker</a>) and create a pull request to neurodocker (add new tool in a branch!)</li>
<li>Clone the neurocontainers repository <a href=https://github.com/NeuroDesk/neurocontainers>https://github.com/NeuroDesk/neurocontainers</a></li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>git clone https://github.com/NeuroDesk/neurocontainers/
</code></pre></div><ol start=3>
<li>Copy the directory template and rename to <em>newapp</em> in <code>neurocontainers/recipes</code></li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>cd neurocontainers/recipes
cp -R template newapp
</code></pre></div><ol start=4>
<li>Modify <code>build.sh</code> in <code>neurocontainers/recipes/newapp</code> to build your application and update README.md (make sure the version is correct in the README!)</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>cd newapp
(edit build.sh as required)
(edit README.md as required)
</code></pre></div><ol start=5>
<li>Run update-builders.sh - This will auto-create the CI workflow for the application (or manually duplicate the template file and rename all occurances of template to <em>newapp</em>)</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>cd ../..
sh update-builders.sh
</code></pre></div><ol start=6>
<li>Build the container locally (e.g. running the build script with the &ndash;debug flag: <a href=https://github.com/NeuroDesk/neurocontainers/blob/master/recipes/lcmodel/build.sh>https://github.com/NeuroDesk/neurocontainers/blob/master/recipes/lcmodel/build.sh</a>)</li>
<li>updated changes in local git repository</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>git add recipes/newapp/build.sh recipes/newapp/README.md .github/workflows/newapp.yml
git config user.email &#34;the email that you use for github&#34;
git config user.name &#34;your name&#34;
git commit
</code></pre></div><ol start=8>
<li>Generate git personal access token (if you don’t have one already)</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Browse to https://github.com/NeuroDesk/neurocontainers/
Press on your picture in upper right corner --&gt; Setting --&gt; Developer Settings --&gt; Personal Access Token
Press on “generate personal access token”
Write something in “Notes” (doesn’t matter what, it’s for your own use)
Check “repo”
Check “Workflow”
Press “Generate Token” at the bottom
Copy the token displayed on the screen into a file, so you’ll have it later
</code></pre></div><ol start=9>
<li>Test the container locally, and if successful push repo to trigger the automatic build on GitHub</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>git pull
git push
</code></pre></div><ol start=10>
<li>Go to neurocontainers/actions. Check that the most recent workflow run in the list terminated successfully (green). Otherwise, click on it, click on “build docker”, and the line that caused the error will be highlighted</li>
<li>Check that the package shows up in repository
Go to <a href="https://github.com/orgs/NeuroDesk/packages?repo_name=neurocontainers">https://github.com/orgs/NeuroDesk/packages?repo_name=neurocontainers</a> and check that the new package is listed</li>
<li>Try to manually download the package to your Machine or VNM</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>bash /neurodesk/local/fetch_and_run.sh newapp newappversion builddate
ml newapp/newappversion
</code></pre></div><ol start=13>
<li>Test the new container. Run some commands, to see all is good</li>
<li>send a pull request to add the container to the apps.json file: <a href=https://github.com/NeuroDesk/neurocommand/blob/main/neurodesk/apps.json>https://github.com/NeuroDesk/neurocommand/blob/main/neurodesk/apps.json</a></li>
<li>(once pull request is merged this will trigger an action to build the singularity container, distribute it in all object storage locations and on CVMFS, and it will update the menus in the desktop image on the next daily build)</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f706aedba5bc93ee895c966642b91365>3.2 - Menu entries</h1>
<div class=lead>Menu entries in neurodesktop</div>
<h2 id=menu-entry>Menu entry</h2>
<p>As we want to propose several versions of the tools, each piece of software should have its own submenu under <code>VNM Neuroimaging</code>.
To do so, you first have to add a submenu to <code>menus/vnm-applications.menu</code> by adding:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- [[Tool Name]] submenu --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;Menu&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;Name&gt;</span>[[Tool Name]]<span style=color:#204a87;font-weight:700>&lt;/Name&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;Directory&gt;</span>vnm-[[tool-name]].directory<span style=color:#204a87;font-weight:700>&lt;/Directory&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;Include&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;And&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;Category&gt;</span>[[Tool-Name]]<span style=color:#204a87;font-weight:700>&lt;/Category&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/And&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/Include&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/Menu&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- End [[Tool Name]] --&gt;</span>
</code></pre></div><p>The following table shows the formatting rules to follow:</p>
<table>
<thead>
<tr>
<th>Placeholder</th>
<th>Rule</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[[Tool name]]</code></td>
<td>Capitalized, spaces</td>
<td><code>ITK snap</code></td>
</tr>
<tr>
<td><code>[[tool-name]]</code></td>
<td>Lower case, no spaces (use <code>-</code> instead)</td>
<td><code>itk-snap</code> or <code>itksnap</code></td>
</tr>
<tr>
<td><code>[[Tool-name]]</code></td>
<td>Capitalized, no spaces (use <code>-</code> instead)</td>
<td><code>ITK-snap</code></td>
</tr>
</tbody>
</table>
<p>Next, we have to create the submenu itself as we referenced it by <code>vnm-[[tool-name]].directory</code>. To do so, create the file <code>menus/submenus/vnm-[[tool-name]].directory</code> and add the following information inside:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#204a87;font-weight:700>[Desktop Entry]</span>
<span style=color:#c4a000>Name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]]</span>
<span style=color:#c4a000>Comment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]]</span>
<span style=color:#c4a000>Icon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/home/neuro/.config/lxpanel/LXDE/icons/[[icon-name]].png</span>
<span style=color:#c4a000>Type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Directory</span>
</code></pre></div><p>If a specific icon is available in the <code>menus/icons</code> directory, replace <code>[[icon-name]]</code> by its name. Otherwise, use <code>vnm</code>.</p>
<h2 id=create-the-application>Create the application</h2>
<p>Finally, we have to create the actual application by creating the file <code>menus/applications/vnm-[[tool-name]]-[[0.0.0]].desktop</code>. The name of this file must contain the version of the tool (once again to allow multiple versions to live inside the same directory). Add the following description to this file:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#204a87;font-weight:700>[Desktop Entry]</span>
<span style=color:#c4a000>Name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]] [[0.0.0]] [[(Install only)]]</span>
<span style=color:#c4a000>GenericName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool Name]] [[0.0.0]]</span>
<span style=color:#c4a000>Comment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>The description of what clicking on this application does. # This will be the tooltip of the application.</span>
<span style=color:#c4a000>Exec</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>The command used to run the application.</span>
<span style=color:#c4a000>Icon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/home/neuro/.config/lxpanel/LXDE/icons/[[icon-name]].png</span>
<span style=color:#c4a000>Type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Application</span>
<span style=color:#c4a000>Categories</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>[[Tool-name]]</span>
<span style=color:#c4a000>Terminal</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>true # or false</span>
</code></pre></div><p>The important part here is the value of <code>Exec</code>. If the tool is in the form of a singularity image, you should run the following command:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash /usr/share/fetch_and_run.sh <span style=color:#ce5c00;font-weight:700>[[</span>tool-name<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>0.0.0<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>YYYYMMDD<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>cmd<span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>[[</span>args<span style=color:#ce5c00;font-weight:700>]]</span>
</code></pre></div><p>What <code>fetch_and_run.sh</code> does is check if the image is already installed as a module. If not, it checks whether it can be installed or not (return <code>1</code> if not possible). After that, it installs the image as a module.
If <code>[[cmd]]</code> is specified, once the image is installed, it runs the command by giving the arguments from <code>[[args]]</code>.
Here are two examples for FreeSurfer and FreeView. This first one only installs the image as a module:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash /usr/share/fetch_and_run.sh freesurfer 6.0.1 <span style=color:#0000cf;font-weight:700>20200506</span>
</code></pre></div><p>And this does the same but runs FreeView afterward:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>bash /usr/share/fetch_and_run.sh freesurfer 6.0.1 <span style=color:#0000cf;font-weight:700>20200506</span> freeview
</code></pre></div><p>The resulting <code>.desktop</code> file corresponding to FreeView contains:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#204a87;font-weight:700>[Desktop Entry]</span>
<span style=color:#c4a000>Name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>FreeView 6.0.1</span>
<span style=color:#c4a000>GenericName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>FreeView 6.0.1</span>
<span style=color:#c4a000>Comment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Start FreeView 6.0.1</span>
<span style=color:#c4a000>Exec</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>bash /usr/share/fetch_and_run.sh freesurfer 6.0.1 20200506 freeview</span>
<span style=color:#c4a000>Icon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/home/neuro/.config/lxpanel/LXDE/icons/run.png</span>
<span style=color:#c4a000>Type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Application</span>
<span style=color:#c4a000>Categories</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>FreeSurfer</span>
<span style=color:#c4a000>Terminal</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>true</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f89498a0fd2d201e1dc7e27d7be9f337>4 - Transparent Singularity</h1>
<div class=lead>For more advanced users who to use Transparent Singularity directly</div>
<p>Transparent singularity is here <a href=https://github.com/NeuroDesk/transparent-singularity/>https://github.com/NeuroDesk/transparent-singularity/</a></p>
<p>This project allows to use singularity containers transparently on HPCs, so that an application inside the container can be used without adjusting any scripts or pipelines (e.g. nipype).</p>
<h2 id=important-add-bind-points-to-bashrc-before-executing-this-script>Important: add bind points to .bashrc before executing this script</h2>
<p>This script expects that you have adjusted the Singularity Bindpoints in your .bashrc, e.g.:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>export SINGULARITY_BINDPATH=&#34;/gpfs1/,/QRISdata,/data&#34;
</code></pre></div><h2 id=this-gives-you-a-list-of-all-tested-images-available-in-neurodesk>This gives you a list of all tested images available in neurodesk:</h2>
<p><a href=https://github.com/NeuroDesk/neurodesk/blob/master/cvmfs/log.txt>https://github.com/NeuroDesk/neurodesk/blob/master/cvmfs/log.txt</a></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>curl -s https://raw.githubusercontent.com/NeuroDesk/neurodesk/master/cvmfs/log.txt
</code></pre></div><h2 id=clone-repo-into-a-folder-with-the-intented-image-name>Clone repo into a folder with the intented image name</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>git clone https://github.com/NeuroDesk/transparent-singularity convert3d_1.0.0_20210104
</code></pre></div><h2 id=install>Install</h2>
<p>This will create scripts for every binary in the container located in the $DEPLOY_PATH inside the container. It will also create activate and deactivate scripts and module files for lmod (<a href=https://lmod.readthedocs.io/en/latest/>https://lmod.readthedocs.io/en/latest/</a>)</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>cd convert3d_1.0.0_20210104
./run_transparent_singularity.sh convert3d_1.0.0_20210104
</code></pre></div><h2 id=options-for-transparent-singularity>Options for Transparent singularity:</h2>
<ul>
<li><code>--storage</code> - this</li>
<li><code>--container</code> - this option can be used to explicitly define the container name to be downloaded</li>
<li><code>--unpack</code> - this will unpack the singularity container so it can be used on systems that do not allow to open simg / sif files for security reasons, e.g.: <code>--unpack true</code></li>
<li><code>--singularity-opts</code> - this will be passed on to the singularity call, e.g.: <code>--singularity-opts '--bind /cvmfs'</code></li>
</ul>
<h1 id=use-in-module-system-lmod>Use in module system LMOD</h1>
<p>Add the module folder path to $MODULEPATH</p>
<h1 id=manual-activation-and-deactivation-in-case-module-system-is-not-available-this-will-add-the-paths-to-the-bashrc>Manual activation and deactivation (in case module system is not available). This will add the paths to the .bashrc</h1>
<h2 id=activate>Activate</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>source activate_convert3d_1.0.0_20210104.sh
</code></pre></div><h2 id=deactivate>Deactivate</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>source deactivate_convert3d_1.0.0_20210104.sif.sh
</code></pre></div><h2 id=uninstall-container-and-cleanup>Uninstall container and cleanup</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>./ts_uninstall.sh
</code></pre></div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label>
<a class=text-white target=_blank rel=noopener href aria-label>
<i></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel=noopener href=https://twitter.com/neuro_desk aria-label=Twitter>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label>
<a class=text-white target=_blank rel=noopener href aria-label>
<i></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label>
<a class=text-white target=_blank rel=noopener href aria-label>
<i></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label>
<a class=text-white target=_blank rel=noopener href aria-label>
<i></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title aria-label>
<a class=text-white target=_blank rel=noopener href aria-label>
<i></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.f6e5038a2fe223cb025ddb9e3f0d6e61c17f7ee07173fa91a33f23be1ed1ab52.js integrity="sha256-9uUDii/iI8sCXduePw1uYcF/fuBxc/qRoz8jvh7Rq1I=" crossorigin=anonymous></script>
<script src=/js/prism.js></script>
</body>
</html>